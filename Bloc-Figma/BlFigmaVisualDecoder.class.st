Class {
	#name : #BlFigmaVisualDecoder,
	#superclass : #Object,
	#category : #'Bloc-Figma'
}

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> cropImage: aForm for: anExtent [

	self halt.
	^ BlElement new
		  background: (BlBackground image: (aForm scaledToSize: anExtent));
		  size: anExtent;
		  yourself
]

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> decodeColor: aDictionnary [

	| color |
	color :=  Color
		  r: (aDictionnary at: #r)
		  g: (aDictionnary at: #g)
		  b: (aDictionnary at: #b).
		aDictionnary at: #a ifPresent: [ :val | ^ color alpha: val ].
	^ color
]

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> decodeEffects: aDictionary [

	^ BlGaussianShadowEffect
		  color: (self decodeColor: (aDictionary at: #color))
		  width: (aDictionary at: #radius)
		  offset:
		  (aDictionary at: #offset at: #x)
		  @ (aDictionary at: #offset at: #y)
]

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> decodeFills: aDictionary withLoader: aLoader for: aBlElement [

	| backgroundType fills |
	(aDictionary at: #fills) ifEmpty: [ ^ self ].
	fills := (aDictionary at: #fills) first.
	fills
		at: #visible
		ifPresent: [ :bool | bool ifFalse: [ ^ BlBackground transparent ] ].
	backgroundType := fills at: #type.
	backgroundType = 'GRADIENT_LINEAR' ifTrue: [
		aBlElement background: (BlBackground paint: (self decodeGradient: fills)) ].
	backgroundType = 'IMAGE' ifTrue: [
			  (self
				   decodeImage: fills
				   withSource: aDictionary
				   withLoader: aLoader
				for: aBlElement) ].
	backgroundType = 'SOLID' ifTrue: [
		aBlElement background: (BlBackground paint: (self decodeColor: (fills at: #color))) ]
]

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> decodeGradient: aDictionnary [

	| stops start end |
	stops := (aDictionnary at: #gradientStops) collect: [ :each |
		         (each at: #position)
		         -> (self decodeColor: (each at: #color)) ].
	self flag: #TODO. "Start and stop"
	start := 0 @ 0.
	end := 0 @ 1.
	^ BlLinearGradientPaint new
		  stops: stops;
		  start: start;
		  end: end;
		  yourself
]

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> decodeImage: aFills withSource: aDictionary withLoader: aLoader for: aBlElement [

	| imageElement image imageHash scaleMode extent scalingFactor |
	imageHash := aFills at: #imageHash.
	image := aLoader picturesDictionary at: imageHash.
	scaleMode := aFills at: #scaleMode.
	scalingFactor := aFills at: #scalingFactor.
	extent := (aDictionary at: #width) @ (aDictionary at: #height).
	scaleMode = #FIT ifTrue: [
		imageElement := self fitImage: image for: extent ].
	scaleMode = #FILL ifTrue: [
		imageElement := self fillImage: image for: extent ].
	scaleMode = #TILE ifTrue: [
		imageElement := self
			                tileImage: image
			with: scalingFactor
			                for: extent ].
	scaleMode = #CROP ifTrue: [
		imageElement := self cropImage: image for: extent ].
	aLoader addElementWithImageBackground: imageElement.
	aBlElement addChild: imageElement.
	^ image
]

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> decodeStrokes: aDictionary [
	
	^ BlBorder builder
		  paint:
			  (self decodeColor: ((aDictionary at: #strokes) first at: #color));
		  width: (aDictionary at: #strokeWeight);
		  build
]

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> fillImage: aForm for: anExtent [

	| offset image scale |
	anExtent y > anExtent x
		ifTrue: [ scale := anExtent y / aForm height ]
		ifFalse: [ scale := anExtent x / aForm width ].

	image := aForm magnify: aForm boundingBox by: scale smoothing: 2.
	
	anExtent y > anExtent x
		ifTrue: [ offset := ((anExtent x / 2) - (image width / 2))@0 ]
		ifFalse: [ offset := 0@((anExtent y / 2) - (image height / 2)) ].

	^ BlElement new
		  background: (BlBackground image: image);
		  position: offset;
		  size: image extent
]

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> fitImage: aForm for: anExtent [

	| offset image |
	image := (aForm scaledToSize: anExtent).
	offset := (anExtent / 2) - (image extent / 2).
	^ BlElement new
		  background: (BlBackground image: image);
		  position: offset;
		  size: anExtent;
		  yourself
]

{ #category : #'as yet unclassified' }
BlFigmaVisualDecoder class >> tileImage: aForm with: aScalingFactor for: anExtent [ 

|  image scaledImageHeight scaledImageWidth numberToFitInWidth numberToFitInHeight firstElement element posW posH|

	image := aForm magnify: aForm boundingBox by: aScalingFactor smoothing: 2.
	
	scaledImageHeight := image height.
	scaledImageWidth := image width.
	
	numberToFitInWidth := (anExtent x/ scaledImageWidth) ceiling.
	numberToFitInHeight := (anExtent y/ scaledImageHeight) ceiling.
	
	firstElement := BlElement new
		  background: (BlBackground image: image);
		  position: 0@0;
		  size: image extent.
		
	2 to: numberToFitInHeight do: [ :j|
			posH := (j-1)*scaledImageHeight.
			element := BlElement new
		  				background: (BlBackground image: image);
						position: 0@(posH);
		  				size: image extent.
		
			firstElement addChild: element.
		 ].
	
	2 to: numberToFitInWidth do: [:i | 
		posW := (i-1)*scaledImageWidth.
		
		1 to: numberToFitInHeight do: [ :j|
			posH := (j-1)*scaledImageHeight.
			element := BlElement new
		  				background: (BlBackground image: image);
						position: (posW)@(posH);
		  				size: image extent.
		
			firstElement addChild: element.
		 ].
		
		 ].
	
	firstElement clipChildren: false.
	

	^ firstElement
]
